<BOUCLE_article_principal(ARTICLES) {id_article=1}>
<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" dir="#LANG_DIR" lang="#LANG" xml:lang="#LANG">
<head>
<title>[(#TITRE|textebrut) - ][(#NOM_SITE_SPIP|textebrut)]</title>
[<meta name="description" content="(#INTRODUCTION|couper{150}|textebrut)" />]
<INCLURE{fond=inc-head-#ID_RUBRIQUE}{id_rubrique}>
<script src="#URL_PAGE{geomap.js}" type="text/javascript"></script>
[(#REM)<script src="#CHEMIN{javascript/firebug/firebug.js}" type="text/javascript"></script>]
<script type="text/javascript" src="#CHEMIN{flash/flowplayer/examples/js/flashembed.min.js}"></script>
<script type="text/javascript" src="#CHEMIN{javascript/jScrollPane/jquery.mousewheel.min.js}"></script>
<script type="text/javascript" src="#CHEMIN{javascript/jScrollPane/jScrollPane.js}"></script>
<link rel="stylesheet" type="text/css" media="all" href="#CHEMIN{javascript/jScrollPane/jScrollPane.css}" />
<script type="text/javascript" src="#CHEMIN{javascript/jScrollPane/jquery.dimensions.min.js}"></script>
<script type="text/javascript" src="#CHEMIN{javascript/extinfowindow/extinfowindow.js}"></script>
<script type="text/javascript">
	//<![CDATA[
	var map;
	var zoom_counter = 1; 
	var fini;
	function load() {
		if (GBrowserIsCompatible()) {
			map = new GMap2(document.getElementById("map"));
			map.disableDoubleClickZoom();
	
			map.setCenter(new GLatLng(#CONFIG{geomap_default_lat},#CONFIG{geomap_default_lonx}), 2);
			points = [];
			time = [];
	
			GDownloadUrl("[(#URL_PAGE{inc-markers}|parametre_url{id_article,#ID_ARTICLE,'&'})]", function(data, responseCode) {
				var xml = GXml.parse(data);
				var markers = xml.documentElement.getElementsByTagName("marker");
				for (var i = 0; i < markers.length; i++) {
					var point = new GLatLng(parseFloat(markers[i].getAttribute("lat")),parseFloat(markers[i].getAttribute("lng")));
					point.text = markers[i].getAttribute("info");
					points.push(point);
					time.push(markers[i].getAttribute("t"));
				}
			});

			var customIcon = new GIcon(G_DEFAULT_ICON);
			customIcon.shadow = '#URL_SITE_SPIP/#CHEMIN{images/reakt5/transparent_point.gif}';
			customIcon.image = '#URL_SITE_SPIP/#CHEMIN{images/reakt5/point.png}';
			customIcon.iconAnchor = new GPoint(6, 6);
			customIcon.shadowSize = new GSize(1,1);
			customIcon.iconSize = new GSize(12,12);
			markerOptions = { icon:customIcon };

			counter = 1;
			cur_time= 7;
		}
	}

	function animateZoom(){
		map.setZoom(map.getZoom()+4);
		zoom_counter++;
		cur_time += 4;
		if (zoom_counter < 4) {
			setTimeout('animateZoom()',4000);	
		}
		else{
			toverlays = [];
			prev_point = new GPoint(0,0);
			curr_point = new GPoint(0,0);
			delete zoom_counter;
			map.setMapType(G_SATELLITE_MAP);
			stop_id = setInterval('drawRoute()', 1000);
		}
	}
	
	function intro(){
		map.setCenter(new GLatLng(#CONFIG{geomap_default_lat},#CONFIG{geomap_default_lonx}),2);
		markermaps = [];
		animateZoom();
	}
	
	function drawRoute(){
		if ((counter == points.length)||(points[counter] == 'undefined')){
			window.clearInterval(stop_id);
			fini = true;
		}
		else if (cur_time == time[counter]){
			if (points[counter].text) {
			  	var marker = new GMarker(curr_point, markerOptions);
			  	map.addOverlay(marker);
			  	
			  	if (!jQuery('#map-nav ul li.on').size()) {
			  		jQuery('#map-nav ul li').eq(0).fadeOut().toggleClass('on').fadeIn();
			  	}
			  	else {
			  		var old = jQuery('#map-nav ul li.on');
			  		old.toggleClass('on');
			  		old.next('li').fadeOut().toggleClass('on').fadeIn();
					var id= jQuery(old).next('li').attr('id');
					$('.scroll-pane')[0].scrollTo('#'+id);
			  	}
				marker.openExtInfoWindow(
					map,
					"reakt",
					"<div id=\'marker_content\'>Loading...<\/div>",
					{beakOffset: 3,paddingY:1}
				);
				jQuery('#marker_content').text(points[counter].text,function(){
					map.getExtInfoWindow().resize();
				});
			}
			curr_point = points[counter];
			prev_point = points[counter-1];
			counter++;
			capture_overlay_flag = 'n';
		}
		else {
			var capture_overlay_flag = 'y';
			var cur_tgap = time[counter]-cur_time;
			var tgap = time[counter]-time[counter-1];
			var xgap = points[counter].x - points[counter-1].x;
			var ygap = points[counter].y - points[counter-1].y;
			curr_point = new GPoint(points[counter].x - (((xgap)/(tgap)) * cur_tgap), points[counter].y - (((ygap)/(tgap)) * cur_tgap));
		}
		
		if (prev_point.x != 0){
			for (var i=0; i<markermaps.length; i++){
				map.removeOverlay(markermaps[i]);
				markermaps.shift();
			}
			var marker = new GMarker(curr_point,markerOptions);
			map.addOverlay(marker);
			markermaps.push(marker);
			
			//var toverlay = new GPolyline([prev_point, curr_point], '#a40000', 5, .8);
			//map.addOverlay(toverlay);
			map.panTo(new GLatLng(curr_point.y,curr_point.x));
			//if (capture_overlay_flag == 'y'){ toverlays.push(toverlay); }
		}
		
		//if (capture_overlay_flag == 'n'){
			//for (var i=0; i<toverlays.length; i++){
			//	map.removeOverlay(toverlays[i]);
			//}
			//delete toverlays;
			//toverlays = [];
		//}
		prev_point = curr_point;
		cur_time ++;
	}
	
	function deletearrays(){
		delete toverlays;
		delete points;
		delete time;
		delete markermaps;
	}
	function playfirst(){
		window.clearInterval(pourcent);
		jQuery('#chargement').hide();
		playall();
	}
	
	function playall(){
		if (document.getElementById("flow_player1").getIsPaused() == true){
			document.getElementById("flow_player1").DoPlay();
			if(document.getElementById("flow_player1").getTime()==0){
				intro();
			}
			else if (cur_time < 8) {
				intro();
			}
			else if((cur_time >22) && (fini != true)){
				stop_id = setInterval('drawRoute()', 1000);
			}
			else if(fini == true){
				window.parent.location.reload();
			}
		}
	}

	function playfile(){
			if(document.getElementById("flow_player1").getTime()==0){
				intro();
			}
			else if (cur_time < 8) {
				intro();
			}
			else if((cur_time >22) && (fini != true)){
				stop_id = setInterval('drawRoute()', 1000);
			}
			else if(fini == true){
				window.parent.location.reload();
			}
	}
	/*
	function onPause(clip){
			if (cur_time > 8) {
				pausefile();
			}
		}
		function onResume(clip){
			if (cur_time > 8) {
				playfile();
			}
		}	
*/
	function stopall(){
		document.getElementById("flow_player1").Reset();
		//window.clearInterval(pan_stop_id);
		//window.clearInterval(stop_id);
	//	deletearrays();
		cur_time = 7;
		load();
	}
	
	function pauseall(){
		if (cur_time < 22) {

		}
		else {
			window.clearInterval(stop_id);
			document.getElementById("flow_player1").Pause();
			document.getElementById("flow_player1").Seek(cur_time-6);
		}
	}
	function pausefile(){
		if (cur_time < 22) {

		}
		else {
			window.clearInterval(stop_id);
		}
	}
	function onFlowPlayerReady(){
		pourcent = setInterval('pourcentage()', 1000);
	}
	function pourcentage(){
		var val = parseFloat(document.getElementById("flow_player1").getPercentLoaded());
		val = (val).toFixed(2);
		jQuery("#val").html(val+'%');
		if ((val > 30)&& (val <99)) {
			if (jQuery('#chargement #close:hidden').size()){
				jQuery('#chargement #close:hidden').fadeIn();
			}
		}
		if (val==100){
			window.clearInterval(pourcent);
			if (jQuery('#chargement #close:hidden').size()){
				jQuery('#chargement #close:hidden').fadeIn();
			}
		}
	}
	jQuery(document).ready(function() {
		jQuery('#chargement').css('opacity',0.9);
		load();

		jQuery('.showhide').bind('click',function(){
			jQuery(this).next('div.cache').toggle();
		});
		
		jQuery('#texte-reakt .closelink').click(function(){
			jQuery(this).parent().toggle(1000).eq(0);
		});
		$(function(){
			$('.scroll-pane').jScrollPane({animateTo:true});
		});
	});
    //]]>
</script>
</head>
<body onunload="GUnload()">
<div id="page" style="position:relative;">
	<div id="conteneur">
		[(#REM) Contenu principal : contenu de l'article ]
		<div id="contenu">
			<div class="cartouche">
				<h1 class="#EDIT{titre} titre">#TITRE</h1>
			</div>
		<div id="conteneur-media">
			<div id="chargement">
				<div><:loading:><br /> <span  id="val"></span><br /><br />
					<div id="close" style="display:none"><a href="javascript:playfirst()"><:close_play:></a></div>
				</div>
			</div>
			<div id="lecteurs" style="height:260px;">
			<div style="float:left;width:347px;overflow:hidden;">
				[(#MODELE{flow_video}{id_player=1}{id_document=66})]
			</div>
			
			<div id="controles">
				<div id="lecture" style="text-align:center">
				<a href="#" onclick="playall();return false;"><img src="#CHEMIN{images/reakt5/bouton_lecture_petit.png}" alt="" /></a><br />
				<a href="#" onclick="pauseall();return false;"><img src="#CHEMIN{images/reakt5/bouton_pause_petit.png}" alt="" /></a><br />
				[(#REM)<a href="#" onclick="stopall();return false;"><img src="#CHEMIN{images/reakt5/bouton_stop_petit.png}" alt="" /></a>]
				</div>
			</div>
				<div id="map-nav" class="scroll-pane"><ul><BOUCLE_donnees(FORMS_DONNEES){id_article}><BOUCLE_champs(FORMS_CHAMPS){id_form}{par rang}{titre==Infos}><BOUCLE_champtitre(SPIP_FORMS_DONNEES_CHAMPS){id_donnee}{champ}>[<li id="li#ID_DONNEE">(#VALEUR*)</li>]</BOUCLE_champtitre></BOUCLE_champs></BOUCLE_donnees></ul></div>
			</div>
			<div id="map-conteneur">
			<div id="map"></div>
			</div>
			</div>
			<br class="nettoyeur" />
			<div id="ps" class="#EDIT{soustitre} ps">
				[(#SOUSTITRE|propre)]
			</div>
			<div id="psdroite" class="ps">
				<BOUCLE_site(SITES){id_rubrique}>
					<p><a href="#URL_SITE" class="spip_out">#NOM_SITE</a></p>
				</BOUCLE_site>
			</div>
			<br class="nettoyeur" />
		</div>
	</div>
	</div>
	<INCLURE{fond=inc-pied}>
</body>
</html>
</BOUCLE_article_principal>