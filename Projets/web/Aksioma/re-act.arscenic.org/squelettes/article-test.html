#CACHE{86400}
<BOUCLE_article_principal(ARTICLES) {id_article}>
<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'>
<html dir="#LANG_DIR" lang="#LANG">
<head>
<title>[(#TITRE|textebrut) - ][(#NOM_SITE_SPIP|textebrut)]</title>
[<meta name="description" content="(#INTRODUCTION|couper{150}|textebrut)" />]
<INCLURE{fond=inc-head[-(#ID_RUBRIQUE)]}>
<script type="text/javascript" src="#CHEMIN{flash/flowplayer/flashembed.js}"></script>
<script src="#URL_PAGE{geomap.js}" type="text/javascript"></script>
<script type="text/javascript">
	//<![CDATA[
	var map;
	var zoom_counter = 1;
	
	function load() {
		if (GBrowserIsCompatible()) {
			map = new GMap2(document.getElementById("map"));
			map.disableDragging();
			map.disableDoubleClickZoom();
			map.addControl(new GMapTypeControl());
	
			map.setCenter(new GLatLng(#CONFIG{geomap_default_lat},#CONFIG{geomap_default_lonx}), 2);
			points = [];
			time = [];
			tiles = [];
	
			GDownloadUrl("[(#URL_PAGE{inc-markers}|parametre_url{id_article,#ID_ARTICLE,'&'})]", function(data, responseCode) {
				var xml = GXml.parse(data);
				var markers = xml.documentElement.getElementsByTagName("marker");
				for (var i = 0; i < markers.length; i++) {
					var point = new GLatLng(parseFloat(markers[i].getAttribute("lat")),parseFloat(markers[i].getAttribute("lng")));
					points.push(point);
					time.push(markers[i].getAttribute("t"));
				}
			});
			emap = map;
			counter = 1;
			cur_time=2;
		}
	}

	function animateZoom(){
		emap.setZoom(emap.getZoom()+4);
		zoom_counter++;
		cur_time += 5;
		console.log('cur_time = '+cur_time);
		if (zoom_counter == 4){
		//	emap.setMapType('G_SATELLITE_MAP');
			window.clearInterval(pan_stop_id);
			toverlays = [];
			delete zoom_counter;
			stop_id = setInterval('drawRoute()', 1000);
		}
	}
	
	function intro(){
		emap.setCenter(new GLatLng(#CONFIG{geomap_default_lat},#CONFIG{geomap_default_lonx}),2);
		pan_stop_id = setInterval('animateZoom()', 5000);
	}

	prev_point = new GPoint(0,0);
	curr_point = new GPoint(0,0);
	
	var customIcon = new GIcon(G_DEFAULT_ICON);
	customIcon.shadow = '#URL_SITE_SPIP/#CHEMIN{images/reakt5/transparent_point.gif}';
	customIcon.image = '#URL_SITE_SPIP/#CHEMIN{images/reakt5/green_point_anim.gif}';
	customIcon.iconAnchor = new GPoint(3, 3);
	customIcon.shadowSize = new GSize(1,1);
	customIcon.iconSize = new GSize(5,5);
	markerOptions = { icon:customIcon };
	
	markermaps = [];
	
	function drawRoute(){
		if (counter == points.length){
			window.clearInterval(stop_id);
		}
		if (cur_time == time[counter]){
			curr_point = points[counter];
			prev_point = points[counter-1];
			counter++;
			capture_overlay_flag = 'n';
		}
		else {
			var capture_overlay_flag = 'y';
			var cur_tgap = time[counter]-cur_time;
			var tgap = time[counter]-time[counter-1];
			var xgap = points[counter].x - points[counter-1].x;
			var ygap = points[counter].y - points[counter-1].y;
			curr_point = new GPoint(points[counter].x - (((xgap)/(tgap)) * cur_tgap), points[counter].y - (((ygap)/(tgap)) * cur_tgap));
		}
		
		if (prev_point.x != 0){
			for (i=0; i<markermaps.length; i++){
				map.removeOverlay(markermaps[i]);
				markermaps.shift();
			}
			var marker = new GMarker(curr_point,markerOptions);
			map.addOverlay(marker);
			markermaps.push(marker);
			
			var toverlay = new GPolyline([prev_point, curr_point], '#a40000', 5, .8);
			emap.addOverlay(toverlay);
			emap.panTo(new GLatLng(curr_point.y,curr_point.x));
			//document.getElementById('coords').innerHTML+="<br>xgap:"+emap.getZoom()+" "+curr_point.x+", "+curr_point.y;
			if (capture_overlay_flag == 'y'){ toverlays.push(toverlay); }
		}
		
		prev_point = curr_point;
		
		if (capture_overlay_flag == 'n'){
			for (i=0; i<toverlays.length; i++){
				emap.removeOverlay(toverlays[i]);
			}
			delete toverlays;
			toverlays = [];
		}
		cur_time++;
	}
	
	function playfirst(){
		jQuery('#chargement').fadeOut();
		playall();
	}
	function playall(){
		if (jQuery("#flow1 > :first")[0].getIsPaused() == true){
			if (cur_time < 3) {
				intro();
			}
			else{
				stop_id = setInterval('drawRoute()', 1000);
			}
			jQuery("#flow1 > :first")[0].DoPlay();
			jQuery("#flow2 > :first")[0].DoPlay();	
		}
		else{
			
		}
	}
	
	function pause_player(){
		jQuery("#flow1 > :first")[0].Pause();
		jQuery("#flow2 > :first")[0].Pause();		
	}
	
	function anim_pause(){
		if (cur_time < 22) {
				window.clearInterval(pan_stop_id);
		}
		else {
			window.clearInterval(stop_id);
		}
	}
	function pauseall(){
		anim_pause();
		pause_player();
	}
	function onFlowPlayerReady(){
		console.log('flowplayer ok');
		setTimeout('pourcentage()',1000);
	}
	
	function pourcentage(){
		var val = parseFloat(jQuery("#flow1 > :first")[0].getPercentLoaded());
		val += parseFloat(jQuery("#flow2 > :first")[0].getPercentLoaded());
		val = (val/2).toFixed(2);
		jQuery("#val").html(val+'%');
		console.log(val);
		if (val > 10) {
			if (jQuery('#chargement #close:hidden').size()){
				jQuery('#chargement #close:hidden').fadeIn();
			}	
		}
		if ((val<100) || (val == 'undefined')){
			setTimeout('pourcentage()',500);
		}
		else {
			console.log('fin preload=> clearInterval');}
	}
	jQuery(document).ready(function() {
		load();

		jQuery('.showhide').bind('click',function(){
			jQuery(this).next('div.cache').toggle();
		});
		
		jQuery('#texte-reakt .closelink').click(function(){
			jQuery(this).parent().toggle(1000).eq(0);
		});
		jQuery('#texte-reakt').show('300');
	});

    //]]>
</script>
</head>

<body onunload="GUnload()">

<div id="page" style="position:relative;">
	<div id="conteneur">
		[(#REM) Contenu principal : contenu de l'article ]
		<div id="contenux">
			<div class="cartouche">
				<h1 class="#EDIT{titre} titre">#TITRE</h1>
			</div>
		<div id="conteneur-media">
			<div id="chargement">
				<div>Please wait at least 10% loaded :<br /> <span  id="val"></span><br /><br />
					<div id="close" style="display:none"><a href="javascript:playfirst()">close & play</a></div>
				</div>
			</div>
			[<div class="#EDIT{chapo} chapo cache">(#CHAPO)</div>]
			[<div  id="texte-reakt" style="display:none;">
				<a href="javascript:;" class="closelink">
					<img src="#CHEMIN{images/reakt5/close.png}" alt="" />
				</a>
				<div id="texte-content">
				(#TEXTE|image_reduire{520,0})
				</div>
			</div>] 

			<div id="lecteurs">
			<div style="float:left;width:400px;overflow:hidden;">
				[(#MODELE{flow_video}{id_player=1}{id_document=10})]
			</div>
			
			<div id="controles">
				<div id="lecture" style="text-align:center">
				<a href="#" onclick="playall();return false;"><img src="#CHEMIN{images/reakt5/bouton_lecture_petit.png}" alt="" /></a><br />
				<a href="#" onclick="pauseall();return false;"><img src="#CHEMIN{images/reakt5/bouton_pause_petit.png}" alt="" /></a><br />
				<a href="#" onclick="stopall();return false;"><img src="#CHEMIN{images/reakt5/bouton_stop_petit.png}" alt="" /></a>
				</div>
			</div>
			
			<div style="float:right;width:400px;overflow:hidden;">
				[(#MODELE{flow_video}{id_player=2}{id_document=14})]
			</div>
			</div>
			<div id="map"></div>
			<br class="nettoyeur" />
		</div>
	</div>
	</div>
	<INCLURE{fond=inc-pied}>
</div>
</body>
</html>
</BOUCLE_article_principal>